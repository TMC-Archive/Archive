name: Detect New Archive Files

on:
  push:
    branches: [ main ]
    paths:
      - 'Archive/**/data.json'

jobs:
  process-new-archive:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get newly added data files
        id: get-new-files
        run: |
          FILES=$(git diff --name-only --diff-filter=A \
            ${{ github.event.before }} \
            ${{ github.sha }} \
            -- 'Archive/**/data.json')
          
          JSON_FILES="[]"
          if [ -n "$FILES" ]; then
            JSON_FILES=$(echo "$FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi
          
          echo "files=$JSON_FILES" >> $GITHUB_OUTPUT
      
      - name: Process each new file
        if: steps.get-new-files.outputs.files != '[]'
        run: |
          echo '${{ steps.get-new-files.outputs.files }}' | jq -r '.[]' | while read file; do
            REL_PATH="${file#Archive/}"
            ENCODED_PATH=$(echo -n "$REL_PATH" | jq -sRr @uri)

            FULL_URL="https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/$file"
            ENCODED_URL=$(echo -n "$FULL_URL" | jq -sRr @uri)

            ENDPOINT="${{ secrets.STORAGE_CATALOG_URL }}/$ENCODED_URL"
            
            curl -v "$ENDPOINT" \
              -H "Authorization: Bearer ${{ secrets.STORAGE_CATALOG_TOKEN }}"
          done
